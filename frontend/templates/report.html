<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your personalized skin condition diagnosis report with treatment, lifestyle, and diet recommendations">
    <title>Diagnosis Report - Skin Disease Expert System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239D8DF1'><circle cx='12' cy='12' r='10'/></svg>">
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">
                <div class="nav-brand-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <span>Skin Disease Expert</span>
            </a>
            
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12h18M3 6h18M3 18h18"/>
                </svg>
            </button>
            
            <div class="nav-links" id="navLinks">
                <a href="/" class="nav-link">Home</a>
                <a href="/diagnosis" class="nav-link">Diagnosis</a>
                <a href="/documentation" class="nav-link">Documentation</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content report-page">
        <div class="container report-container">
            <!-- Report Header -->
            <div class="report-header">
                <div class="result-status success" id="resultStatus">
                    <svg class="result-status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <span id="statusText">Diagnosis Complete</span>
                </div>
                <h1 class="section-title">Your Diagnosis Report</h1>
                <p class="section-subtitle" id="reportSubtitle">
                    Based on your symptoms, here is your personalized analysis
                </p>
            </div>

            <!-- No Result Message -->
            <div id="noResultMessage" class="glass-card text-center" style="display: none;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--warning); margin-bottom: 24px;">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 8v4"/>
                    <path d="M12 16h.01"/>
                </svg>
                <h2 style="color: white; margin-bottom: 16px;">No Diagnosis Result Found</h2>
                <p class="text-muted" style="margin-bottom: 32px;">Please complete the diagnosis form first to receive your personalized report.</p>
                <a href="/diagnosis" class="btn btn-primary">Start Diagnosis</a>
            </div>

            <!-- Report Content -->
            <div class="report-grid" id="reportContent" style="display: none;">
                <!-- Disease Overview Card -->
                <div class="glass-card result-card">
                    <div class="result-card-header">
                        <div class="result-card-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4"/>
                                <path d="M12 8h.01"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="result-card-title">Detected Condition</h2>
                            <p class="result-card-subtitle">Disease Overview</p>
                        </div>
                    </div>
                    <div class="result-card-body">
                        <h3 class="disease-name" id="diseaseName">-</h3>
                        <p class="disease-description" id="diseaseDescription">-</p>
                        <span class="disease-tag not-contagious" id="diseaseTag">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span id="diseaseTagText">Non-Contagious</span>
                        </span>
                    </div>
                </div>

                <!-- Treatment Card -->
                <div class="glass-card result-card">
                    <div class="result-card-header">
                        <div class="result-card-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="result-card-title">Suggested Treatment</h2>
                            <p class="result-card-subtitle">Recommended therapies</p>
                        </div>
                    </div>
                    <div class="result-card-body">
                        <ul class="recommendation-list" id="treatmentList">
                            <!-- Treatment items will be inserted here -->
                        </ul>
                    </div>
                </div>

                <!-- Lifestyle Card -->
                <div class="glass-card result-card">
                    <div class="result-card-header">
                        <div class="result-card-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="result-card-title">Suggested Lifestyle</h2>
                            <p class="result-card-subtitle">Daily habits to improve</p>
                        </div>
                    </div>
                    <div class="result-card-body">
                        <ul class="recommendation-list" id="lifestyleList">
                            <!-- Lifestyle items will be inserted here -->
                        </ul>
                    </div>
                </div>

                <!-- Diet Card -->
                <div class="glass-card result-card">
                    <div class="result-card-header">
                        <div class="result-card-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                                <line x1="6" y1="1" x2="6" y2="4"/>
                                <line x1="10" y1="1" x2="10" y2="4"/>
                                <line x1="14" y1="1" x2="14" y2="4"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="result-card-title">Diet Recommendation</h2>
                            <p class="result-card-subtitle">Nutritional guidance</p>
                        </div>
                    </div>
                    <div class="result-card-body">
                        <ul class="recommendation-list" id="dietList">
                            <!-- Diet items will be inserted here -->
                        </ul>
                    </div>
                </div>

                <!-- Explanation Card -->
                <div class="glass-card result-card">
                    <button class="explanation-toggle" id="explanationToggle">
                        <span>View Rule Explanation</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="explanation-content" id="explanationContent">
                        <p class="text-muted mb-4">The following rules were applied to generate your diagnosis:</p>
                        <div id="rulesList">
                            <!-- Rules will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Disclaimer -->
                <div class="disclaimer">
                    <svg class="disclaimer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div class="disclaimer-text">
                        <strong>Important Notice:</strong> This is an educational expert system and should not replace professional medical advice. The results are based on rule-based inference and may not account for all factors. Please consult a qualified dermatologist for accurate diagnosis and treatment.
                    </div>
                </div>

                <!-- Report Actions -->
                <div class="report-actions">
                    <a href="/diagnosis" class="btn btn-primary">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="1 4 1 10 7 10"/>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                        </svg>
                        New Diagnosis
                    </a>
                    <a href="/documentation" class="btn btn-secondary">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        View Documentation
                    </a>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p class="footer-text">
                    © 2025 Skin Disease Expert System. For educational purposes only.
                </p>
            </div>
        </footer>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading your report...</p>
    </div>

    <script>
        // Navbar scroll effect
        window.addEventListener('scroll', () => {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // Mobile menu toggle
        const navToggle = document.getElementById('navToggle');
        const navLinks = document.getElementById('navLinks');
        
        navToggle.addEventListener('click', () => {
            navLinks.classList.toggle('open');
        });

        // Explanation toggle
        const explanationToggle = document.getElementById('explanationToggle');
        const explanationContent = document.getElementById('explanationContent');

        explanationToggle.addEventListener('click', () => {
            explanationToggle.classList.toggle('open');
            explanationContent.classList.toggle('open');
        });

        // Load and display results
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const reportContent = document.getElementById('reportContent');
            const noResultMessage = document.getElementById('noResultMessage');

            // First try to get from sessionStorage (from form submission)
            let result = sessionStorage.getItem('diagnosisResult');
            
            if (result) {
                result = JSON.parse(result);
                displayResults(result);
                reportContent.style.display = 'grid';
            } else {
                // Try to get from server session
                loadingOverlay.classList.add('active');
                
                try {
                    const response = await fetch('/api/get-result');
                    const data = await response.json();
                    
                    if (data.success || data.disease) {
                        displayResults(data);
                        reportContent.style.display = 'grid';
                    } else {
                        noResultMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    noResultMessage.style.display = 'block';
                }
                
                loadingOverlay.classList.remove('active');
            }
        });

        function displayResults(result) {
            const resultStatus = document.getElementById('resultStatus');
            const statusText = document.getElementById('statusText');
            const reportSubtitle = document.getElementById('reportSubtitle');

            if (!result.success && !result.disease) {
                // No diagnosis found
                resultStatus.classList.remove('success');
                resultStatus.classList.add('warning');
                statusText.textContent = 'No Diagnosis Found';
                reportSubtitle.textContent = result.message || 'Unable to determine a diagnosis based on the provided symptoms.';
                
                document.getElementById('diseaseName').textContent = 'Unknown Condition';
                document.getElementById('diseaseDescription').textContent = 'The expert system could not identify a specific condition based on your symptoms. Please consult a healthcare professional.';
                
                return;
            }

            // Disease Overview
            document.getElementById('diseaseName').textContent = result.disease || '-';
            document.getElementById('diseaseDescription').textContent = result.disease_description || 'No description available.';

            // Contagious tag
            const diseaseTag = document.getElementById('diseaseTag');
            const diseaseTagText = document.getElementById('diseaseTagText');
            
            if (result.contagious) {
                diseaseTag.classList.remove('not-contagious');
                diseaseTag.classList.add('contagious');
                diseaseTagText.textContent = 'Contagious';
                diseaseTag.querySelector('svg').innerHTML = '<circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/>';
            } else {
                diseaseTag.classList.remove('contagious');
                diseaseTag.classList.add('not-contagious');
                diseaseTagText.textContent = 'Non-Contagious';
            }

            // Treatment List
            const treatmentList = document.getElementById('treatmentList');
            treatmentList.innerHTML = '';
            if (result.treatment && result.treatment.length > 0) {
                result.treatment.forEach(item => {
                    treatmentList.appendChild(createRecommendationItem(item, 'treatment'));
                });
            } else {
                treatmentList.innerHTML = '<li class="recommendation-item"><div class="recommendation-text text-muted">No specific treatment recommendations.</div></li>';
            }

            // Lifestyle List
            const lifestyleList = document.getElementById('lifestyleList');
            lifestyleList.innerHTML = '';
            if (result.lifestyle && result.lifestyle.length > 0) {
                result.lifestyle.forEach(item => {
                    lifestyleList.appendChild(createRecommendationItem(item, 'lifestyle'));
                });
            } else {
                lifestyleList.innerHTML = '<li class="recommendation-item"><div class="recommendation-text text-muted">No specific lifestyle recommendations.</div></li>';
            }

            // Diet List
            const dietList = document.getElementById('dietList');
            dietList.innerHTML = '';
            if (result.diet && result.diet.length > 0) {
                result.diet.forEach(item => {
                    dietList.appendChild(createRecommendationItem(item, 'diet'));
                });
            } else {
                dietList.innerHTML = '<li class="recommendation-item"><div class="recommendation-text text-muted">No specific diet recommendations.</div></li>';
            }

            // Rules Explanation
            const rulesList = document.getElementById('rulesList');
            rulesList.innerHTML = '';
            if (result.explanation && result.explanation.length > 0) {
                result.explanation.forEach(rule => {
                    const ruleItem = document.createElement('div');
                    ruleItem.className = 'rule-item';
                    ruleItem.innerHTML = `
                        <div class="rule-header">
                            <span class="rule-layer">Layer ${rule.layer}</span>
                            <span class="rule-name">${rule.name}</span>
                        </div>
                        <div class="rule-logic">${rule.logic} → ${Array.isArray(rule.conclusion) ? rule.conclusion.join(', ') : rule.conclusion}</div>
                    `;
                    rulesList.appendChild(ruleItem);
                });
            } else {
                rulesList.innerHTML = '<p class="text-muted">No rules were applied.</p>';
            }
        }

        function createRecommendationItem(text, type) {
            const li = document.createElement('li');
            li.className = 'recommendation-item';
            
            const iconSvg = getIconForType(type);
            
            li.innerHTML = `
                <div class="recommendation-icon">
                    ${iconSvg}
                </div>
                <span class="recommendation-text">${text}</span>
            `;
            
            return li;
        }

        function getIconForType(type) {
            switch(type) {
                case 'treatment':
                    return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
                case 'lifestyle':
                    return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
                case 'diet':
                    return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
                default:
                    return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
            }
        }
    </script>
</body>
</html>
